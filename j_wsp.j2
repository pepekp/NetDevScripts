!
!
ip vrf {{ce_vrf_name}}
 descripton Monitoring
 rd 65534:100
!
interface Loopback100
 description Monitoring
 ip vrf forwarding {{ce_vrf_name}}
 ip address {{lo_addr}} 255.255.255.255


interface {{wanif}}.100
 description Customer {{slid}}
 encapsulation dot1Q 100
 ip vrf forwarding {{ ce_vrf_name }}
 ip address {{ce_wan}} 255.255.255.252
!
!
router bgp {{local_asn}}
 bgp router-id {{ce_wan}}
 bgp log-neighbor-changes
 timers bgp 10 30
 address-family ipv4 vrf {{ ce_vrf_name }}
  redistribute connected route-map BGP-EXPORT
  redistribute static route-map BGP-EXPORT
  neighbor {{bgp_nbr}} remote-as 65534
  neighbor {{bgp_nbr}} description WAN uplink {{slid}} 
  neighbor {{bgp_nbr}} activate
  neighbor {{bgp_nbr}} soft-reconfiguration inbound
  neighbor {{bgp_nbr}} route-map BGP-IMPORT in
  neighbor {{bgp_nbr}} route-map BGP-EXPORT out
  no auto-summary
  no synchronization
 exit-address-family
!
ip prefix-list BGP-EXPORT description Advertise only networks in this list
ip prefix-list BGP-EXPORT seq 5 deny 0.0.0.0/0
ip prefix-list BGP-EXPORT seq 10 permit {{lo_addr}}/32
!
route-map BGP-EXPORT permit 10
 match ip address prefix-list BGP-EXPORT
 set metric 10
!
route-map BGP-IMPORT permit 10
 set metric 10
 set local-preference 1000
!
!
route-map BGP-EXPORT-LO permit 10
 match ip address prefix-list BGP-EXPORT
 set metric 20

end

##
## Juniper PE configuration 
##

set policy-options policy-statement customer-EBGP-VRF-2171-{{jslid}}-EXPORT term 10 from community customer-MATCH-EXTCOM-SOO-{{jslid}}
set policy-options policy-statement customer-EBGP-VRF-2171-{{jslid}}-EXPORT term 10 then reject
set policy-options policy-statement customer-EBGP-VRF-2171-{{jslid}}-EXPORT then accept
set policy-options policy-statement customer-EBGP-VRF-2171-{{jslid}}-IMPORT term 10 then community add customer-SET-EXTCOM-SOO-{{jslid}}
set policy-options policy-statement customer-EBGP-VRF-2171-{{jslid}}-IMPORT then accept
set policy-options policy-statement customer-VRF-2171-EXPORT term 10 from protocol static
set policy-options policy-statement customer-VRF-2171-EXPORT term 10 from protocol direct
set policy-options policy-statement customer-VRF-2171-EXPORT term 10 from protocol bgp
set policy-options policy-statement customer-VRF-2171-EXPORT term 10 then community add customer-SET-EXTCOM-RT-8928:1429
set policy-options policy-statement customer-VRF-2171-EXPORT term 10 then accept
set policy-options policy-statement customer-VRF-2171-EXPORT then reject
set policy-options policy-statement customer-VRF-2171-IMPORT term 10 from protocol bgp
set policy-options policy-statement customer-VRF-2171-IMPORT term 10 from community customer-MATCH-EXTCOM-RT-8928:1429
set policy-options policy-statement customer-VRF-2171-IMPORT term 10 then accept
set policy-options policy-statement customer-VRF-2171-IMPORT then reject
set routing-instances {{ vrf_name }} description "VRF Description"
set routing-instances {{ vrf_name }} instance-type vrf
set routing-instances {{ vrf_name }} interface {{peif}}
set routing-instances {{ vrf_name }} route-distinguisher 8928:2037
set routing-instances {{ vrf_name }} vrf-import customer-VRF-2171-IMPORT
set routing-instances {{ vrf_name }} vrf-export customer-VRF-2171-EXPORT
set routing-instances {{ vrf_name }} vrf-export IPVPN-LEGACY-SITE-PRIORITY
set routing-instances {{ vrf_name }} vrf-table-label
set routing-instances {{ vrf_name }} routing-options auto-export
set routing-instances {{ vrf_name }} protocols bgp group customer type external
set routing-instances {{ vrf_name }} protocols bgp group customer minimum-hold-time 15
set routing-instances {{ vrf_name }} protocols bgp group customer family inet unicast prefix-limit maximum 500
set routing-instances {{ vrf_name }} protocols bgp group customer neighbor {{ce_wan}} description "Customer name {{slid}}"
set routing-instances {{ vrf_name }} protocols bgp group customer neighbor {{ce_wan}} hold-time 30
set routing-instances {{ vrf_name }} protocols bgp group customer neighbor {{ce_wan}} import customer-EBGP-VRF-{{jslid}}-IMPORT
set routing-instances {{ vrf_name }} protocols bgp group customer neighbor {{ce_wan}} export customer-EBGP-VRF-{{jslid}}-EXPORT
set routing-instances {{ vrf_name }} protocols bgp group customer neighbor {{ce_wan}} peer-as {{local_asn}}
set routing-instances {{ vrf_name }} protocols bgp group customer neighbor {{ce_wan}} as-override

set policy-options community customer-MATCH-EXTCOM-RT-8928:1429 members target:8928:1429
set policy-options community customer-SET-EXTCOM-RT-8928:1429 members target:8928:1429

set policy-options community customer-MATCH-EXTCOM-SOO-{{jslid}} members origin:8928:{{jslid}}
set policy-options community customer-SET-EXTCOM-SOO-{{jslid}} members origin:8928:{{jslid}}



