!
!
ip vrf WSP
 descripton Monitoring
 rd 65534:100
!
interface Loopback100
 description Monitoring
 ip vrf forwarding WSP
 ip address {{lo_addr}} 255.255.255.255


interface {{wanif}}.100
 description WPS Monitoring {{slid}}
 encapsulation dot1Q 100
 ip vrf forwarding WSP
 ip address {{ce_wan}} 255.255.255.252
!
!
router bgp {{local_asn}}
 bgp router-id {{ce_wan}}
 bgp log-neighbor-changes
 timers bgp 10 30
 address-family ipv4 vrf WSP
  redistribute connected route-map BGP-EXPORT-PRI
  redistribute static route-map BGP-EXPORT-PRI
  neighbor {{bgp_nbr}} remote-as 3257
  neighbor {{bgp_nbr}} description WAN uplink {{slid}} 
  neighbor {{bgp_nbr}} activate
  neighbor {{bgp_nbr}} soft-reconfiguration inbound
  neighbor {{bgp_nbr}} route-map SET-MED-IN-10 in
  neighbor {{bgp_nbr}} route-map BGP-EXPORT-PRI out
  no auto-summary
  no synchronization
 exit-address-family
!
ip prefix-list BGP-EXPORT description Advertise to PE only networks in this list 
ip prefix-list BGP-EXPORT seq 5 deny 0.0.0.0/0
ip prefix-list BGP-EXPORT seq 10 permit {{lo_addr}}/32
!
route-map BGP-EXPORT-PRI permit 10
 match ip address prefix-list BGP-EXPORT
 set metric 10
!
route-map SET-MED-IN-10 permit 10
 set metric 10
 set local-preference 900
!
route-map SET-MED-IN-20 permit 10
 set metric 20
!
route-map BGP-EXPORT-LO permit 10
 match ip address prefix-list BGP-EXPORT
 set metric 20

end

##
## Juniper PE configuration 
##

set policy-options policy-statement customer-8928-EBGP-VRF-2171-{{jslid}}-EXPORT term 10 from community customer-8928-MATCH-EXTCOM-SOO-{{jslid}}
set policy-options policy-statement customer-8928-EBGP-VRF-2171-{{jslid}}-EXPORT term 10 then reject
set policy-options policy-statement customer-8928-EBGP-VRF-2171-{{jslid}}-EXPORT then accept
set policy-options policy-statement customer-8928-EBGP-VRF-2171-{{jslid}}-IMPORT term 10 then community add customer-8928-SET-EXTCOM-SOO-{{jslid}}
set policy-options policy-statement customer-8928-EBGP-VRF-2171-{{jslid}}-IMPORT then accept
set policy-options policy-statement customer-8928-VRF-2171-EXPORT term 10 from protocol static
set policy-options policy-statement customer-8928-VRF-2171-EXPORT term 10 from protocol direct
set policy-options policy-statement customer-8928-VRF-2171-EXPORT term 10 from protocol bgp
set policy-options policy-statement customer-8928-VRF-2171-EXPORT term 10 then community add customer-8928-SET-EXTCOM-RT-8928:1429
set policy-options policy-statement customer-8928-VRF-2171-EXPORT term 10 then accept
set policy-options policy-statement customer-8928-VRF-2171-EXPORT then reject
set policy-options policy-statement customer-8928-VRF-2171-IMPORT term 10 from protocol bgp
set policy-options policy-statement customer-8928-VRF-2171-IMPORT term 10 from community customer-8928-MATCH-EXTCOM-RT-8928:1429
set policy-options policy-statement customer-8928-VRF-2171-IMPORT term 10 then accept
set policy-options policy-statement customer-8928-VRF-2171-IMPORT then reject
set routing-instances l3vpn-8928-VRF-2171 description "Telenor Sverige AB - WSP Monitoring"
set routing-instances l3vpn-8928-VRF-2171 instance-type vrf
set routing-instances l3vpn-8928-VRF-2171 interface {{peif}}
set routing-instances l3vpn-8928-VRF-2171 route-distinguisher 8928:2037
set routing-instances l3vpn-8928-VRF-2171 vrf-import customer-8928-VRF-2171-IMPORT
set routing-instances l3vpn-8928-VRF-2171 vrf-export customer-8928-VRF-2171-EXPORT
set routing-instances l3vpn-8928-VRF-2171 vrf-export IPVPN-LEGACY-SITE-PRIORITY
set routing-instances l3vpn-8928-VRF-2171 vrf-table-label
set routing-instances l3vpn-8928-VRF-2171 routing-options auto-export
set routing-instances l3vpn-8928-VRF-2171 protocols bgp group VRF-2171 type external
set routing-instances l3vpn-8928-VRF-2171 protocols bgp group VRF-2171 minimum-hold-time 15
set routing-instances l3vpn-8928-VRF-2171 protocols bgp group VRF-2171 family inet unicast prefix-limit maximum 500
set routing-instances l3vpn-8928-VRF-2171 protocols bgp group VRF-2171 neighbor {{ce_wan}} description "Telenor Sverige AB WSP {{slid}}"
set routing-instances l3vpn-8928-VRF-2171 protocols bgp group VRF-2171 neighbor {{ce_wan}} hold-time 30
set routing-instances l3vpn-8928-VRF-2171 protocols bgp group VRF-2171 neighbor {{ce_wan}} import customer-8928-EBGP-VRF-2171-{{jslid}}-IMPORT
set routing-instances l3vpn-8928-VRF-2171 protocols bgp group VRF-2171 neighbor {{ce_wan}} import FILTER-NMS-SHARED-POLICY
set routing-instances l3vpn-8928-VRF-2171 protocols bgp group VRF-2171 neighbor {{ce_wan}} export customer-8928-EBGP-VRF-2171-{{jslid}}-EXPORT
set routing-instances l3vpn-8928-VRF-2171 protocols bgp group VRF-2171 neighbor {{ce_wan}} peer-as {{local_asn}}
set routing-instances l3vpn-8928-VRF-2171 protocols bgp group VRF-2171 neighbor {{ce_wan}} as-override

set policy-options community customer-8928-MATCH-EXTCOM-RT-8928:1429 members target:8928:1429 
set policy-options community customer-8928-SET-EXTCOM-RT-8928:1429 members target:8928:1429 

set policy-options community customer-8928-MATCH-EXTCOM-SOO-{{jslid}} members origin:8928:{{jslid}}
set policy-options community customer-8928-SET-EXTCOM-SOO-{{jslid}} members origin:8928:{{jslid}}



